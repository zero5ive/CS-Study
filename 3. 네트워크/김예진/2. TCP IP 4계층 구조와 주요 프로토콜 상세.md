# TCP/IP 4계층

## 애플리케이션 계층 (Application Layer)
웹 서비스, 이메일 등 사용자에게 실질적인 서비스를 제공하는 최상위 계층.

- 네트워크 통신의 최종 목적지로, 하위 계층에서 온 데이터를 사용자가 이해할 수 있는 형태(텍스트, 이미지 등)로 변환함.
- 반대로 사용자 데이터를 전송 가능한 형식으로 인코딩하여 하위 계층으로 전달함.

### 주요 프로토콜

#### HTTP (Hypertext Transfer Protocol)
서버와 브라우저 간 데이터를 주고받기 위한 프로토콜이나, 현재는 서버 간 통신에도 널리 사용된다.

* **특징**:
    - **헤더(Header) 기반 확장**: 헤더에 다양한 값을 넣어 사용자 맞춤 응답, 세션 관리, 캐시 정책 등을 효율적으로 운용 가능.
    - **무상태성(Stateless)**: 연속된 요청 사이의 상태(State)를 보존하지 않음. 각 요청은 독립적으로 처리된다.

#### SSH (Secure Shell Protocol)
보안되지 않은 네트워크에서 암호화된 통신을 통해 서비스를 안전하게 운영하기 위한 프로토콜.

* **활용**:
    - **원격 접속**: AWS EC2 같은 인스턴스에 CLI 환경으로 접근하여 작업. 
      (예: `ssh -i [프라이빗키] [사용자]@[IP주소]`)
    - **파일 전송**: SCP(Secure Copy) 명령어를 통해 파일 전송 가능함.


#### FTP (File Transfer Protocol)
노드 간 파일을 전송하는 프로토콜. 현재는 보안 문제로 인해 암호화 버전인 **FTPS**나 **SFTP**로 대체되고 있다.

- 파일질라(FileZilla) 같은 소프트웨어를 사용하여 로컬과 원격 서버 간 파일을 주고받음.

#### SMTP (Simple Mail Transfer Protocol)
인터넷을 통해 메일을 보낼 때 사용되는 프로토콜. 
서비스 내에서 메일링 기능을 구축하는 경우 이를 통해 보내야 한다. 

- **Nodemailer (Node.js)**: 자바스크립트 환경에서 SMTP를 통해 메일을 보낼 수 있게 돕는 라이브러리. (호스트, 포트, 인증 정보 설정 필요)

## L4. 전송 계층 (Transport Layer)

애플리케이션 계층에서 받은 메시지를 기반으로 데이터를 쪼개고, 목적지까지 오류 없이 순서대로 전달되도록 돕는 계층.

- **PDU:** **세그먼트(TCP)** 또는 **데이터그램(UDP)**.


### TCP (Transmission Control Protocol)
신뢰성 있는 연결을 중시하는 프로토콜. **가상회선 패킷 교환 방식**으로 패킷을 교환한다. 연결을 먼저 설정하고 데이터를 주고받는 논리적 경로를 확보한다.

![](https://velog.velcdn.com/images/yejiiiin/post/59090321-f4f8-40ad-a80f-0f02e99b97e6/image.png)

**오류 검사 메커니즘**: 

1. **재전송**: 시간 초과 발생 시 전달되지 않은 데이터를 다시 보냄.
2. **체크섬**: 송신/수신 데이터의 체크섬 값을 비교하여 무결성을 평가함.
3. **순서 보장**: 쪼개진 패킷에 번호를 부여하여 수신 측에서 순서대로 재조립함.

**헤더**: 
20~60바이트의 가변 길이.

**연결 관리**: 
3-Way Handshake(연결 맺기)와 4-Way Handshake(연결 해제) 과정을 거침.

#### 3-Way Handshake
장치 간 신뢰성 있는 통로를 만들기 위해 거치는 3단계 확인 과정.

**과정** 

1. **SYN (Synchronize)**: 클라이언트가 서버에 연결 요청을 보냄. 이때 자신의 고유 번호인 **ISN**(Initial Sequence Number)을 담아 보냄.
2. **SYN + ACK**: 서버는 클라이언트의 요청을 받고, 확인했다(ACK)는 신호와 함께 자신의 ISN을 담아 서버도 연결 요청(SYN)을 보냄. (승인 번호로 클라이언트 ISN + 1 전달)
3. **ACK (Acknowledgment)**: 클라이언트는 서버의 응답을 확인했다는 마지막 신호를 보냄. (승인 번호로 서버 ISN + 1 전달)

**서버 & 클라이언트 상태 변화**
- **클라이언트**: CLOSED → **SYN_SENT** → **ESTABLISHED**(연결 완료)
- **서버**: CLOSED → **LISTEN**(대기 중) → **SYN_RECEIVED** → **ESTABLISHED**(연결 완료)

#### 4-Way handshake
지연 패킷 등 데이터가 남아있을 수 있기 때문에 연결을 맺을 때보다 끊을 때 더 신중한 과정을 거친다.

**과정**

1. **FIN (Finish)**: 클라이언트가 연결을 닫고 싶을 때 세그먼트를 보냄. (**FIN_WAIT_1** 상태 진입)
2. **ACK**: 서버가 일단 확인했다는 신호를 보냄. (**CLOSE_WAIT** 상태 진입). 클라이언트는 이를 받고 서버가 남은 일을 마칠 때까지 기다림. (**FIN_WAIT_2** 상태 진입)
3. **FIN**: 서버가 남은 처리를 모두 마친 뒤, 클라이언트에 연결을 끊을 준비가 되었다고 보냄. (**LAST_ACK** 상태 진입)
4. **ACK**: 클라이언트가 최종 확인 신호를 보냄. 서버는 즉시 **CLOSED** 상태가 됨.

- **TIME_WAIT**
클라이언트가 마지막 ACK를 보낸 후 바로 연결을 닫지 않고 일정 시간(2 * MSL(최대 패킷 수명)) 동안 기다리는 상태. OS마다 다르지만 보통 60초~4분 정도 유지된다.

  **목적**
   1. **지연 패킷 처리**: 
    네트워크 혼잡으로 뒤늦게 도착한 패킷이 새로운 연결의 데이터와 섞여 무결성이 깨지는 것을 방지함.
   2. **정상 종료 보장**: 
    마지막 ACK가 서버에 제대로 전달되지 않았을 경우, 서버가 LAST_ACK 상태로 무한 대기하는 것을 방지함. 





### UDP (User Datagram Protocol)
신뢰성보다는 속도와 효율성을 중시하는 프로토콜. **데이터그램 패킷 교환 방식**을 이용한다. 패킷들이 독립적으로 최적의 경로를 찾아 전송된다.

![](https://velog.velcdn.com/images/yejiiiin/post/e80ab26c-9ccd-4543-81b0-5fe21628fdf4/image.png)

**특징**:
- 연결 설정 과정(Handshake)이 없어 지연 시간이 짧음.
- 데이터가 순서대로 도착하는 것을 보장하지 않음.
- **브로드캐스트(1:N 전송)** 지원이 가능함.

**오류 검사 매커니즘**: 
단순한 체크섬만 지원하며, 데이터가 유실되어도 재전송하지 않음.

**헤더**: 
8바이트의 고정 길이를 사용하여 매우 가볍고 빠름.


### TCP vs UDP 비교

| 구분 | TCP (전송 제어 프로토콜) | UDP (데이터그램 프로토콜) |
| :--- | :--- | :--- |
| **패킷 교환 방식** | 가상회선 방식 | 데이터그램 방식 |
| **신뢰성/순서 보장** | O (매우 높음) | X (보장 안 됨) |
| **오류 검사** | 체크섬 + **재전송** | 체크섬 |
| **연결 보장** | 연결 지향 (Handshake) | 비연결형 |
| **헤더 길이** | 20 ~ 60바이트 (가변) | 8바이트 (고정) |
| **속도** | 상대적으로 느림 | 매우 빠름 |
| **전송 방식** | 1:1 통신 (Unicast) | 1:N (Broadcast), M:N 가능 |


## L3. 인터넷 계층 (Internet Layer)

전송 계층에서 받은 세그먼트(TCP) 또는 데이터그램(UDP)을 **패킷화**하여 목적지로 전송하는 역할. 한 노드에서 다른 노드로 데이터를 보낼 때 최적의 경로를 찾는 **라우팅(Routing)**이 핵심이다.

- **주요 프로토콜**: IP, ICMP, ARP 등.
- **PDU**: 패킷 (Packet)

### ICMP (Internet Control Message Protocol)
**노드와 노드 사이에서 통신이 원활한지 확인하고 진단**하는 프로토콜. 
즉, 데이터 전송 목적보다는 **네트워크 테스트 및 진단**에 활용된다.

- **예시**: **ping** 명령어를 통해 특정 서버와 통신이 가능한지 테스트.
  - `ping www.google.com` 실행 시 ICMP Echo Request/Reply 메시지를 주고받음.


### 기타 주요 프로토콜
- **IP (Internet Protocol)**: 패킷에 주소를 부여하고 경로를 설정함.
- **ARP (Address Resolution Protocol)**: 논리적 주소인 **IP 주소**를 기반으로 실제 통신에 필요한 물리적 주소인 **MAC 주소**를 찾아냄.

## L2. 링크 계층 (Link Layer)
실제 물리적 매체(랜카드, 스위치, 공유기 등)를 통해 데이터를 전달하는 하드웨어적인 층. 에러 검출(CRC)을 수행하며, MAC 주소를 사용하여 인접 장치 간 통신을 담당한다.

- **PDU: 프레임, 비트**


# 계층별 네트워크 장비 

상위 계층 장비는 하위 계층의 기능을 포함하지만, 하위 계층 장비는 상위 계층의 데이터를 처리할 수 없다. 

**레이어별 요약**

| 계층 (Layer) | 계층 이름 | 주요 장치 | 주요 프로토콜 | PDU (Protocol Data Unit) | 주소(Address) | 주요 역할 |
|---|---|---|---|---|---|---|
| L7 | 애플리케이션 계층 | L7 스위치 (ALB) | HTTP, HTTPS, FTP, SMTP, DNS | Message | N/A | 사용자와 가장 가까운 계층, 애플리케이션 서비스 제공 및 URL/헤더/쿠키 기반 처리 |
| L4 | 전송 계층 | L4 스위치 (NLB) | TCP, UDP | Segment / Datagram | Port Number | 프로세스 간 통신, 신뢰성 보장(TCP) 및 포트 기반 데이터 전달 |
| L3 | 네트워크 계층 | 라우터, L3 스위치 | IP, ICMP | Packet | IP Address | 논리적 주소(IP)를 기반으로 경로 선택 및 라우팅 |
| L2 | 데이터 링크 계층 | L2 스위치, 브리지 | Ethernet, Wi-Fi | Frame | MAC Address | 동일 네트워크 내에서 물리적 주소(MAC) 기반 데이터 전달 |
| L1 | 물리 계층 | NIC, 리피터, AP | N/A | Bit | N/A | 전기/무선 신호를 통한 실제 데이터 전송 |


# 1. 애플리케이션 계층 
## L7 스위치 (로드밸런서)

서버 부하 분산 및 이중화를 통해 보안과 가용성을 높이는 기기. IP, Port 뿐만 아니라 URL, HTTP 헤더, 쿠키 등을 분석하여 트래픽을 정교하게 분배한다.

![](https://velog.velcdn.com/images/yejiiiin/post/4d24a890-997b-4c4d-86fb-36ef0d89ee68/image.png)


- 헬스 체크: 서버에 반복적인 요청을 보내 정상 동작 여부를 확인하고, 장애 발생 시 해당 서버를 배제.

> AWS 서비스에서 ALB (Application Load Balancer)가 이에 해당

# 2. 전송 계층
## L4 스위치

IP 주소와 포트 번호를 참조하여 트래픽을 분산한다. TCP/UDP 헤더를 기반으로 우선순위를 판단하며, L7 스위치와 마찬가지로 헬스 체크 기능을 수행한다.

![](https://velog.velcdn.com/images/yejiiiin/post/9ad4a5a2-9032-4aab-acbf-53c28784602d/image.png)

> AWS 서비스: NLB (Network Load Balancer)가 이에 해당

# 3. 인터넷 계층
## 라우터

![](https://velog.velcdn.com/images/yejiiiin/post/b3ac3ceb-a0d5-4744-a5cd-1f0ff1f8dd04/image.png)

서로 다른 네트워크 간의 경로를 선택(Routing)하는 장비. 패킷 소모 최소화 및 경로 최적화를 담당한다.

## L3 스위치
L2 스위치 기능에 라우팅 기능을 합친 장비. 라우팅 테이블을 참조하여 IP 패킷을 목적지로 전달한다.

# 4. 데이터 링크 계층

TCP계층의 링크계층을 쪼개서 데이터링크계층과 물리계층으로 나눌 수 있다. 

- 데이터 링크 계층: ‘이더넷 프레임’을 통해 에러 확인, 흐름 제어, 접근 제어를 담당하는 계층
- 물리 계층: 무선 LAN과 유선LAN을 통해 0과 1로 이루어진 데이터를 보내는 계층

## L2 스위치

장치들의 MAC 주소를 테이블로 관리하며, 목적지 MAC 주소에 맞춰 이더넷 프레임을 전달하는 역할.

## 브리지

두 개의 LAN을 연결하여 하나의 통신망을 구축할 때 쓰이는 장치로 통신망 범위를 확장하는 역할.

![](https://velog.velcdn.com/images/yejiiiin/post/f7ddc7eb-8422-430b-92e3-aecc1c664e29/image.png)


# 5. 물리 계층
## NIC (Network Interface Card)

PC에 설치되는 LAN 카드로, 고유 식별 번호인 MAC 주소를 가짐.

## 리피터

감쇠된 전기 신호를 증폭하여 더 멀리 전달하는 장치.

## AP (Access Point)

유선 LAN을 무선 신호로 변환하여 무선 네트워크망을 구축해 주는 장치.


---

## 퀴즈

<details>
<summary><b>Q: HTTP의 'Stateless' 특성 때문에 로그인을 유지하려면 무엇이 필요한가요?</b></summary>
<div markdown="1">
<b>A:</b> 서버가 요청자를 기억하지 못하므로, 쿠키(Cookie), 세션(Session), 혹은 JWT 같은 토큰 기술을 사용하여 상태를 증명해야 한다.
</div>
</details>
<details>
<summary><b>Q: 실시간 스트리밍 서비스나 온라인 게임에서는 왜 TCP보다 UDP를 선호하나요?</b></summary>
<div markdown="1">
<b>A:</b> 실시간 서비스는 약간의 데이터 유실보다 <b>지연 시간(Latency) 최소화</b>가 더 중요하기 때문이다. TCP는 데이터 유실 시 재전송을 시도하며 기다리지만, UDP는 연결 수립 과정이 없고 지체 없이 다음 데이터를 바로 보내 속도가 훨씬 빠르다.
</div>
</details>
<details>
<summary><b>Q: 가상회선 패킷 교환(TCP)과 데이터그램 패킷 교환(UDP)의 가장 큰 차이는?</b></summary>
<div markdown="1">
<b>A:</b> 가상회선은 모든 패킷이 <b>동일한 경로</b>를 따라 순서대로 가지만, 데이터그램 방식은 각 패킷이 <b>서로 다른 경로</b>로 갈 수 있으며 도착 순서도 보장되지 않는다.
</div>
</details>

<details>
<summary><b>Q: TCP는 왜 굳이 3번이나 신호를 주고받으며 연결을 맺나요?</b></summary>
<div markdown="1">
<b>A:</b> 양방향 통신이 가능한지 확인하고, 데이터의 순서를 맞추기 위한 <b>고유 번호(ISN)</b>를 서로 동기화하여 <b>신뢰성 있는 연결</b>을 보장하기 위함임.
</div>
</details>

<details>
<summary><b>Q: 4-Way Handshake에서 클라이언트가 서버보다 늦게 완전히 종료되는 이유는?</b></summary>
<div markdown="1">
<b>A:</b> <b>TIME_WAIT</b> 시간 때문임. 뒤늦게 올 수 있는 패킷을 모두 수거하고, 연결이 올바르게 닫혔는지 확인하기 위해 일정 시간을 기다린 후에 CLOSED 상태가 됨.
</div>
</details>


<details>
<summary><b>Q: 서버에 ping을 보냈을 때 응답이 오지 않는다면, 어느 계층의 문제일 가능성이 높은가요?</b></summary>
<div markdown="1">
<b>A:</b> 인터넷 계층(L3) 이하의 문제일 가능성이 크다. IP 설정 오류, 라우팅 경로 문제, 혹은 방화벽에서 ICMP 프로토콜을 차단하고 있는 경우이다.
</div>
</details>
<details>
<summary><b>Q: ICMP는 전송 계층(L4) 프로토콜인 UDP나 TCP처럼 데이터를 실어 나르나요?</b></summary>
<div markdown="1">
<b>A:</b> ICMP는 사용자 데이터를 전송하는 목적이 아니라, 네트워크 장치 간에 상태 정보를 주고받거나 오류를 알리기 위한 통제용 프로토콜이다.
</div>
</details>